<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gig Worker Pay Calculator - Powered by Hey Dispatch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="/auth.js"></script>
  <script>
    console.log('🚀 PAGE STARTING TO LOAD...');
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🎯 DOM LOADED! Page is ready!');
    });
  </script>

  <style>
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card { backdrop-filter: blur(10px); }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-100 min-h-screen">


  <div id="mainContent" class="max-w-6xl mx-auto p-4 space-y-6">
    <!-- Header -->
    <header class="text-center space-y-2 relative z-20">
      <div class="flex justify-between items-center mb-4">
        <div></div> <!-- Spacer -->
        <div id="auth-section" class="flex items-center space-x-4 relative z-30">
          <a id="loginBtn" href="/auth/google" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all relative z-40 cursor-pointer">
            <i class="fab fa-google mr-2"></i>Sign in with Google
          </a>
          <div id="userInfo" class="flex items-center space-x-3 hidden">
            <img id="userPicture" class="w-8 h-8 rounded-full" />
            <span id="userName" class="text-slate-300 font-medium"></span>
            <button id="logoutBtn" class="text-red-400 hover:text-red-300 font-semibold relative z-40 cursor-pointer">Logout</button>
          </div>
        </div>
      </div>
      <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
        <i class="fas fa-truck-moving mr-3"></i>Gig Worker Pay Calculator
      </h1>
      <p class="text-slate-400 text-lg">Calculate your true hourly rate after expenses for any gig work</p>
      <p class="text-slate-500 text-sm mt-1">Powered by Hey Dispatch</p>
      <div class="mt-4 p-3 bg-blue-900/30 rounded-lg border border-blue-700/30">
        <p class="text-blue-300 text-sm">
          <i class="fas fa-info-circle mr-2"></i>
          <strong>Tip:</strong> Fill in your actual numbers and watch the results update in real-time!
        </p>
      </div>
    </header>



    <!-- Main Calculator -->
    <div class="grid lg:grid-cols-3 gap-6 relative">
      <!-- Lock Overlay (shown when not authenticated) -->
      <div id="lockOverlay" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm rounded-2xl z-10 flex items-center justify-center">
        <div class="text-center">
          <i class="fas fa-lock text-6xl text-slate-400 mb-4"></i>
          <h3 class="text-xl font-semibold text-slate-300 mb-2">Calculator Locked</h3>
          <p class="text-slate-400">Please sign in to access the calculator</p>
        </div>
      </div>
      <!-- Inputs -->
      <div class="lg:col-span-2 space-y-6">
        <section class="bg-slate-800/60 rounded-2xl p-6 ring-1 ring-white/10">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fas fa-calculator mr-2 text-indigo-400"></i>Earnings & Time
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-slate-300 font-medium">Hours Worked</label>
              <input id="hours" type="number" step="0.1" min="0" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="0" placeholder="0.0" oninput="validateDecimal(this, 0)">
              <p class="text-xs text-slate-500 mt-1">Include all time from start to finish</p>
            </div>
            <div>
              <label class="text-sm text-slate-300 font-medium">Total Miles Driven</label>
              <input id="miles" type="number" step="0.1" min="0" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="0" placeholder="0.0" oninput="validateDecimal(this, 0)">
              <p class="text-xs text-slate-500 mt-1">All miles including deadhead</p>
            </div>
            <div>
              <label class="text-sm text-slate-300 font-medium">Base Pay ($)</label>
              <input id="gross" type="number" step="0.01" min="0" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="0" placeholder="0.00" oninput="validateDecimal(this, 0)">
              <p class="text-xs text-slate-500 mt-1">Base pay from gig</p>
            </div>
            <div>
              <label class="text-sm text-slate-300 font-medium">Tips + Bonuses ($)</label>
              <input id="tips" type="number" step="0.01" min="0" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="0" placeholder="0.00" oninput="validateDecimal(this, 0)">
              <p class="text-xs text-slate-500 mt-1">Customer tips and incentives</p>
            </div>
            <div>
              <label class="text-sm text-slate-300 font-medium">On-Trip Miles (Optional)</label>
              <input id="onTripMiles" type="number" step="0.1" min="0" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="" placeholder="0.0" oninput="validateDecimal(this, 0)">
              <p class="text-xs text-slate-500 mt-1">Miles while actively delivering</p>
            </div>
            <div>
              <label class="text-sm text-slate-300 font-medium">Number of Stops (Optional)</label>
              <input id="stops" type="number" step="1" min="0" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="" placeholder="0" oninput="validateDecimal(this, 0)">
              <p class="text-xs text-slate-500 mt-1">Total deliveries/pickups completed</p>
            </div>
            <div>
              <label class="text-sm text-slate-300 font-medium">Fees & Commissions ($)</label>
              <input id="fees" type="number" step="0.01" min="0" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="0" placeholder="0.00" oninput="validateDecimal(this, 0)">
              <p class="text-xs text-slate-500 mt-1">Any platform fees or commissions</p>
            </div>
          </div>
        </section>

        <section class="bg-slate-800/60 rounded-2xl p-6 ring-1 ring-white/10">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fas fa-gas-pump mr-2 text-indigo-400"></i>Vehicle Costs
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-slate-300 font-medium">Gas Price ($/gallon)</label>
              <input id="gas" type="number" step="0.01" min="0" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="0" placeholder="0.00" oninput="validateDecimal(this, 0)">
              <p class="text-xs text-slate-500 mt-1">Current local gas price</p>
            </div>
            <div>
              <label class="text-sm text-slate-300 font-medium">Vehicle MPG</label>
              <input id="mpg" type="number" step="0.1" min="0" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="0" placeholder="0.0" oninput="validateDecimal(this, 0)">
              <p class="text-xs text-slate-500 mt-1">Your vehicle's fuel efficiency</p>
            </div>
            <div>
              <label class="text-sm text-slate-300 font-medium">Wear & Tear ($/mile)</label>
              <input id="wear" type="number" step="0.01" min="0" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="0.67" placeholder="0.00" oninput="validateDecimal(this, 0)">
              <p class="text-xs text-slate-500 mt-1">Typical range: $0.60-$0.70/mile</p>
            </div>
            <div>
              <label class="text-sm text-slate-300 font-medium">Estimated Tax Rate (%)</label>
              <input id="tax" type="number" step="0.1" min="0" max="100" class="w-full mt-1 rounded-lg bg-slate-700 ring-1 ring-white/10 p-3 text-lg" value="0" placeholder="0.0" oninput="validateDecimal(this, 0, 100)">
              <p class="text-xs text-slate-500 mt-1">Self-employment tax estimate</p>
            </div>
          </div>
        </section>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3">
          <button id="calcBtn" class="px-6 py-3 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 font-semibold transition-all">
            <i class="fas fa-calculator mr-2"></i>Calculate
          </button>
          <button id="scorecardBtn" class="px-6 py-3 rounded-xl bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 font-semibold transition-all">
            <i class="fas fa-trophy mr-2"></i>Create Scorecard
          </button>
          <button id="saveBtn" class="px-6 py-3 rounded-xl bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 font-semibold transition-all">
            <i class="fas fa-save mr-2"></i>Save
          </button>
          <button id="shareBtn" class="px-6 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 ring-1 ring-white/10 font-semibold transition-all">
            <i class="fas fa-share mr-2"></i>Share Link
          </button>
          <button id="copyBtn" class="px-6 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 ring-1 ring-white/10 font-semibold transition-all">
            <i class="fas fa-copy mr-2"></i>Copy Summary
          </button>
          <button id="resetBtn" class="px-6 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 ring-1 ring-white/10 font-semibold transition-all">
            <i class="fas fa-redo mr-2"></i>Reset
          </button>
        </div>
      </div>

      <!-- Results Sidebar -->
      <div class="space-y-6">
        <section class="bg-slate-800/60 rounded-2xl p-6 ring-1 ring-white/10">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fas fa-chart-line mr-2 text-indigo-400"></i>Results
          </h2>
          <div class="space-y-4">
            <div class="stat-card bg-slate-700/60 rounded-xl p-4 ring-1 ring-white/5">
              <div class="text-sm text-slate-400">Gross Hourly Rate</div>
              <div id="grossHourly" class="text-2xl font-bold text-green-400">$40.00/hr</div>
            </div>
            <div class="stat-card bg-slate-700/60 rounded-xl p-4 ring-1 ring-white/5">
              <div class="text-sm text-slate-400">Real Hourly Rate</div>
              <div id="realHourly" class="text-2xl font-bold text-blue-400">$28.50/hr</div>
              <div class="text-xs text-slate-500 mt-1">After costs & taxes</div>
            </div>
            <div class="stat-card bg-slate-700/60 rounded-xl p-4 ring-1 ring-white/5">
              <div class="text-sm text-slate-400">Net Profit</div>
              <div id="netProfit" class="text-2xl font-bold text-purple-400">$142.50</div>
            </div>
            <div class="stat-card bg-slate-700/60 rounded-xl p-4 ring-1 ring-white/5">
              <div class="text-sm text-slate-400">Cost Breakdown</div>
              <div class="space-y-2 mt-2">
                <div class="flex justify-between text-sm">
                  <span>Fuel:</span>
                  <span id="fuelCost" class="text-red-400">$16.85</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span>Wear & Tear:</span>
                  <span id="vehicleCost" class="text-red-400">$80.40</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span>Taxes:</span>
                  <span id="estTax" class="text-red-400">$12.38</span>
                </div>
              </div>
            </div>
                         <div class="stat-card bg-slate-700/60 rounded-xl p-4 ring-1 ring-white/5">
               <div class="text-sm text-slate-400">Per Mile Rates</div>
               <div class="space-y-2 mt-2">
                 <div class="flex justify-between text-sm">
                   <span>Gross (all miles):</span>
                   <span id="grossPerMile" class="text-green-400">$1.67/mi</span>
                 </div>
                 <div class="flex justify-between text-sm">
                   <span>Net (all miles):</span>
                   <span id="dollarsPerMile" class="text-blue-400">$1.19/mi</span>
                 </div>
                 <div class="flex justify-between text-sm">
                   <span>Gross (on-trip):</span>
                   <span id="activeGrossDpm" class="text-green-400">-</span>
                 </div>
                 <div class="flex justify-between text-sm">
                   <span>Net (on-trip):</span>
                   <span id="activeDpm" class="text-blue-400">-</span>
                 </div>
               </div>
             </div>
            <div class="stat-card bg-slate-700/60 rounded-xl p-4 ring-1 ring-white/5">
              <div class="text-sm text-slate-400">Per Stop Rates</div>
              <div class="space-y-2 mt-2">
                <div class="flex justify-between text-sm">
                  <span>Gross per stop:</span>
                  <span id="grossPerStop" class="text-green-400">-</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span>Net per stop:</span>
                  <span id="netPerStop" class="text-blue-400">-</span>
                </div>
              </div>
            </div>
            <div class="stat-card bg-slate-700/60 rounded-xl p-4 ring-1 ring-white/5">
              <div class="text-sm text-slate-400">Target Analysis</div>
              <div class="space-y-2 mt-2">
                <div class="flex justify-between text-sm">
                  <span>Break-even:</span>
                  <span id="breakEvenHr" class="text-yellow-400">$21.93/hr</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span>For $30/hr:</span>
                  <span id="reqGross" class="text-green-400">$246.00</span>
                </div>
              </div>
            </div>
          </div>
        </section>


      </div>
    </div>

    <!-- Summary Section -->
    <section class="bg-slate-800/60 rounded-2xl p-6 ring-1 ring-white/10">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <i class="fas fa-file-alt mr-2 text-indigo-400"></i>Summary
      </h2>
      <pre id="summary" class="whitespace-pre-wrap text-sm text-slate-300 bg-slate-900/60 p-4 rounded-lg ring-1 ring-white/5 font-mono"></pre>
    </section>

    <footer class="text-center text-sm text-slate-500 py-6">
      <p>This calculator provides estimates only. Consult with a tax professional for accurate tax advice.</p>
      <p class="mt-2">Built for gig workers by gig workers 💪</p>
    </footer>
  </div>

  <!-- Scorecard Modal -->
  <div id="scorecardModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-slate-800 rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-white">Gig Scorecard</h2>
        <button id="closeScorecard" class="text-slate-400 hover:text-white text-2xl">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div id="scorecardContent" class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-xl p-6 border border-slate-600">
        <!-- Scorecard will be generated here -->
      </div>
      
      <div class="flex gap-3 mt-6">
        <button id="shareScorecard" class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-semibold rounded-lg transition-all flex-1">
          <i class="fas fa-download mr-2"></i>Download Image
        </button>
        <button id="copyScorecard" class="px-6 py-3 bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white font-semibold rounded-lg transition-all">
          <i class="fas fa-share-alt mr-2"></i>Share Image
        </button>
      </div>
    </div>

  </div>

  <!-- Saved Summaries Section -->
  <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 py-8">
    <div class="max-w-6xl mx-auto px-4">
      <!-- Section Header -->
      <div class="text-center mb-8">
        <h2 class="text-4xl font-bold text-white mb-4">
          <i class="fas fa-bookmark text-indigo-400 mr-3"></i>
          Saved Calculation Summaries
        </h2>
        <p class="text-slate-300 text-lg">
          Review your gig work performance history and track your earnings over time
        </p>
        <div class="mt-4 flex items-center justify-center space-x-4">
          <div class="bg-slate-800/50 px-4 py-2 rounded-lg">
            <span class="text-slate-400 text-sm">Total Saved:</span>
            <span id="totalSavedCount" class="text-white font-bold ml-2">0</span>
          </div>
          <button id="exportCalculations" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm font-medium text-white transition-all">
            <i class="fas fa-download mr-1"></i>Export Data
          </button>
        </div>
      </div>

      <!-- Saved Calculations Dashboard -->
      <div class="bg-slate-800/60 rounded-2xl p-6 ring-1 ring-white/10 backdrop-blur-sm">
        <!-- Controls Header -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
          <div class="flex items-center space-x-4">
            <h3 class="text-xl font-semibold text-slate-200 flex items-center">
              <i class="fas fa-chart-line mr-2 text-green-400"></i>
              Your Calculation History
              <span id="calculationCount" class="ml-2 text-sm bg-indigo-600 px-3 py-1 rounded-full text-white hidden"></span>
            </h3>
          </div>
          
          <div class="flex items-center space-x-2">
            <select id="sortCalculations" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-200 text-sm focus:ring-2 focus:ring-indigo-500">
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
              <option value="highest_score">Highest Score</option>
              <option value="lowest_score">Lowest Score</option>
              <option value="highest_earnings">Highest Earnings</option>
            </select>
            <button id="toggleViewMode" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-medium transition-all hidden">
              <i class="fas fa-list mr-1"></i>Show All
            </button>
            <button id="refreshCalculations" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm font-medium text-white transition-all">
              <i class="fas fa-sync-alt mr-1"></i>Refresh
            </button>
          </div>
        </div>

        <!-- Quick Stats -->
        <div id="quickStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 hidden">
          <div class="bg-slate-700/50 rounded-lg p-4">
            <div class="text-slate-400 text-sm">Average Score</div>
            <div id="avgScore" class="text-2xl font-bold text-white">--</div>
          </div>
          <div class="bg-slate-700/50 rounded-lg p-4">
            <div class="text-slate-400 text-sm">Best Hourly</div>
            <div id="bestHourly" class="text-2xl font-bold text-green-400">$0.00</div>
          </div>
          <div class="bg-slate-700/50 rounded-lg p-4">
            <div class="text-slate-400 text-sm">Total Hours</div>
            <div id="totalHours" class="text-2xl font-bold text-blue-400">0</div>
          </div>
          <div class="bg-slate-700/50 rounded-lg p-4">
            <div class="text-slate-400 text-sm">Total Earnings</div>
            <div id="totalEarnings" class="text-2xl font-bold text-purple-400">$0.00</div>
          </div>
        </div>
        
        <!-- Calculations Display Container -->
        <div id="savedCalculationsContainer">
          <div id="calculationsLoading" class="text-center py-16 text-slate-400">
            <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
            <p class="text-lg">Loading your saved calculations...</p>
            <p class="text-sm text-slate-500 mt-2">This may take a moment</p>
          </div>
          
          <div id="noCalculations" class="text-center py-16 text-slate-500 hidden">
            <i class="fas fa-chart-line text-6xl mb-6 text-slate-600"></i>
            <h3 class="text-2xl font-bold mb-4">No Calculations Saved Yet</h3>
            <p class="text-slate-400 mb-6 max-w-md mx-auto">
              Start by completing a calculation above and clicking the "Save" button to build your performance history.
            </p>
            <div class="space-y-3">
              <button id="manualLoad" class="block mx-auto px-6 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-medium text-white transition-all">
                <i class="fas fa-sync-alt mr-2"></i>Try Loading Again
              </button>
              <div class="flex items-center justify-center space-x-2">
                <button id="testAdminView" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm font-medium text-white transition-all">
                  <i class="fas fa-database mr-1"></i>Admin View
                </button>
                <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium text-white transition-all">
                  <i class="fas fa-arrow-up mr-1"></i>Back to Calculator
                </button>
              </div>
            </div>
          </div>
          
          <div id="calculationsList" class="space-y-4 hidden">
            <!-- Calculations will be populated here -->
          </div>
          
          <div id="paginationControls" class="mt-6 flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 hidden">
            <div class="text-sm text-slate-400">
              Showing <span id="showingRange"></span> of <span id="totalCalculations"></span> calculations
            </div>
            <div class="flex items-center space-x-2">
              <button id="prevPage" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-left mr-1"></i>Previous
              </button>
              <span id="pageInfo" class="px-3 py-2 text-sm text-slate-300 bg-slate-700/50 rounded-lg"></span>
              <button id="nextPage" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                Next<i class="fas fa-chevron-right ml-1"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Performance Insights -->
      <div id="performanceInsights" class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
        <div class="bg-slate-800/60 rounded-2xl p-6 ring-1 ring-white/10">
          <h4 class="text-lg font-semibold text-slate-200 mb-4">
            <i class="fas fa-trophy text-yellow-400 mr-2"></i>Top Performing Calculations
          </h4>
          <div id="topCalculations" class="space-y-3">
            <!-- Top calculations will be populated here -->
          </div>
        </div>
        
        <div class="bg-slate-800/60 rounded-2xl p-6 ring-1 ring-white/10">
          <h4 class="text-lg font-semibold text-slate-200 mb-4">
            <i class="fas fa-calendar text-blue-400 mr-2"></i>Recent Activity
          </h4>
          <div id="recentActivity" class="space-y-3">
            <!-- Recent activity will be populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>

    const fields = ["hours","miles","gross","tips","gas","mpg","wear","fees","tax","onTripMiles","stops"];
    
    // Required fields for scorecard
    const requiredFields = ["hours", "miles", "gross", "tips", "gas", "mpg", "wear", "tax"];



    const $ = (id) => document.getElementById(id);

    function read() {
      const v = {};
      fields.forEach(f => {
        const raw = $(f).value.trim();
        v[f] = raw === "" ? "" : Number(raw);
      });
      return v;
    }

    function fmt(n, d=2) {
      if (isNaN(n) || n === null || n === undefined) return "$0.00";
      const fixed = Number(n).toFixed(d);
      return (Number(fixed) < 0 ? "-$" + Math.abs(Number(fixed)).toLocaleString() : "$" + Number(fixed).toLocaleString());
    }
    
    function fmtHr(n){ return isNaN(n) || n === null || n === undefined ? "$0.00/hr" : "$" + n.toFixed(2) + "/hr"; }
    function fmtMi(n){ return isNaN(n) || n === null || n === undefined ? "$0.00/mi" : "$" + n.toFixed(2) + "/mi"; }

    function calc() {
      const v = read();
      
      // Input validation and sanitization
      const hours = Math.max(parseFloat(v.hours) || 0, 0.0001);
      const miles = Math.max(parseFloat(v.miles) || 0, 0);
      const gross = (parseFloat(v.gross) || 0) + (parseFloat(v.tips) || 0);
      const gasPrice = Math.max(parseFloat(v.gas) || 0, 0);
      const mpg = Math.max(parseFloat(v.mpg) || 0, 0.0001);
      const wear = Math.max(parseFloat(v.wear) || 0, 0);
      const fees = Math.max(parseFloat(v.fees) || 0, 0);
      const taxRate = Math.min(Math.max(parseFloat(v.tax) || 0, 0), 100) / 100;
      const onTripMiles = Math.max(parseFloat(v.onTripMiles) || 0, 0);

      // Costs
      const fuelCost = (miles / mpg) * gasPrice;
      const vehicleCost = miles * wear;
      const costBeforeTax = fuelCost + vehicleCost + fees;

      // Profit & tax
      const profitBeforeTax = gross - costBeforeTax;
      // Tax is calculated on gross earnings, not just positive profit
      const estTax = gross * taxRate;
      const netProfit = profitBeforeTax - estTax;

      // Rates (with safety checks)
      const grossHourly = hours > 0 ? gross / hours : 0;
      const realHourly = hours > 0 ? netProfit / hours : 0;
      const grossPerMile = miles > 0 ? gross / miles : 0;
      const netPerMile = miles > 0 ? netProfit / miles : 0;
      const activeGrossDpm = onTripMiles > 0 ? gross / onTripMiles : 0;
      const activeNetDpm = onTripMiles > 0 ? netProfit / onTripMiles : 0;
      
      // Per-stop rates (new)
      const stops = Math.max(parseFloat(v.stops) || 0, 0);
      const grossPerStop = stops > 0 ? gross / stops : 0;
      const netPerStop = stops > 0 ? netProfit / stops : 0;

      // Targets
      const breakEvenHr = hours > 0 ? (costBeforeTax + estTax) / hours : 0;
      const targetHr = 30;
      const reqGrossForTarget = targetHr * hours + costBeforeTax + estTax;

      // Update UI with animations
      updateStat("grossHourly", fmtHr(grossHourly), "text-green-400");
      updateStat("realHourly", fmtHr(realHourly), "text-blue-400");
      updateStat("netProfit", fmt(netProfit), "text-purple-400");
      updateStat("fuelCost", fmt(fuelCost), "text-red-400");
      updateStat("vehicleCost", fmt(vehicleCost), "text-red-400");
      updateStat("estTax", fmt(estTax), "text-red-400");
      updateStat("grossPerMile", fmtMi(grossPerMile), "text-green-400");
      updateStat("dollarsPerMile", fmtMi(netPerMile), "text-blue-400");
      updateStat("activeGrossDpm", fmtMi(activeGrossDpm), "text-green-400");
      updateStat("activeDpm", fmtMi(activeNetDpm), "text-blue-400");
      updateStat("grossPerStop", stops > 0 ? fmt(grossPerStop) : "-", "text-green-400");
      updateStat("netPerStop", stops > 0 ? fmt(netPerStop) : "-", "text-blue-400");
      updateStat("breakEvenHr", fmtHr(breakEvenHr), "text-yellow-400");
      updateStat("reqGross", fmt(reqGrossForTarget), "text-green-400");

      const summary = [
        `🚛 GIG CALCULATOR SUMMARY`,
        `⏱️  Hours: ${hours.toFixed(1)} | 🛣️  Miles: ${miles.toFixed(1)}`,
        `💰 Gross: ${fmt(gross)} | Real Hourly: ${fmtHr(realHourly)} (Gross: ${fmtHr(grossHourly)})`,
        `💸 Costs → Fuel: ${fmt(fuelCost)}, Wear: ${fmt(vehicleCost)}, Fees: ${fmt(fees)}, Tax: ${fmt(estTax)}`,
        `💵 Net Profit: ${fmt(netProfit)} | $/mi (gross/net): ${fmtMi(grossPerMile)}/${fmtMi(netPerMile)}` + (onTripMiles > 0 ? ` | On-trip: ${fmtMi(activeGrossDpm)}/${fmtMi(activeNetDpm)}` : ""),
        `🎯 To hit $${targetHr}/hr: need ${fmt(reqGrossForTarget)} gross`,
        `📊 Break-even rate: ${fmtHr(breakEvenHr)}`
      ].join("\n");
      
      $("summary").textContent = summary;

      // Persist data
      localStorage.setItem("gigCalc", JSON.stringify(read()));
    }

    function updateStat(id, text, colorClass) {
      const element = $(id);
      if (element) {
        element.className = `text-2xl font-bold ${colorClass}`;
        element.textContent = text;
      }
    }

    function load() {
      // URL params → fields
      const params = new URLSearchParams(location.search);
      if (params.size) {
        fields.forEach(f => {
          const val = params.get(f);
          if (val !== null) $(f).value = val;
        });
      } else {
        // localStorage fallback
        const saved = localStorage.getItem("gigCalc");
        if (saved) {
          const obj = JSON.parse(saved);
          fields.forEach(f => { if (obj[f] !== undefined) $(f).value = obj[f]; });
        }
      }
      calc();
    }

    function shareLink() {
      const v = read();
      const params = new URLSearchParams();
      fields.forEach(f => {
        const raw = $(f).value.trim();
        if (raw !== "") params.set(f, raw);
      });
      const url = location.origin + location.pathname + "?" + params.toString();
      navigator.clipboard.writeText(url).then(() => {
        showNotification("Link copied to clipboard!", "success");
      });
    }

    function copySummary() {
      const txt = $("summary").textContent;
      navigator.clipboard.writeText(txt).then(() => {
        showNotification("Summary copied to clipboard!", "success");
      });
    }

    function resetAll() {
      fields.forEach(f => $(f).value = "");
      localStorage.removeItem("gigCalc");
      history.replaceState({}, "", location.pathname);
      calc();
    }

    function showNotification(message, type = "info") {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-semibold z-50 ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 'bg-blue-600'
      }`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }



    // Event listeners
    $("calcBtn").addEventListener("click", calc);
    $("scorecardBtn").addEventListener("click", createScorecard);
    $("saveBtn").addEventListener("click", saveCurrentCalculation);
    $("shareBtn").addEventListener("click", shareLink);
    $("copyBtn").addEventListener("click", copySummary);
    $("resetBtn").addEventListener("click", resetAll);
    fields.forEach(f => $(f).addEventListener("input", calc));
    
    // Scorecard modal listeners
    document.getElementById('closeScorecard').addEventListener('click', closeScorecard);
    document.getElementById('shareScorecard').addEventListener('click', shareScorecard);
    document.getElementById('copyScorecard').addEventListener('click', copyScorecardImageUrl);
    
    // Auth event listeners
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    console.log('🔍 Auth Debug Info:');
    console.log('Login button found:', loginBtn);
    console.log('Logout button found:', logoutBtn);
    console.log('signInWithGoogle function:', typeof signInWithGoogle);
    console.log('signOut function:', typeof signOut);
    console.log('Window.signInWithGoogle:', typeof window.signInWithGoogle);
    
    if (loginBtn) {
      loginBtn.addEventListener('click', (e) => {
        console.log('🖱️ Login button clicked!');
        e.preventDefault();
        
        // Try different ways to call the sign-in function
        if (typeof signInWithGoogle === 'function') {
          console.log('📞 Calling signInWithGoogle directly');
          signInWithGoogle();
        } else if (typeof window.signInWithGoogle === 'function') {
          console.log('📞 Calling window.signInWithGoogle');
          window.signInWithGoogle();
        } else {
          console.error('❌ signInWithGoogle function not found!');
          // Fallback: direct redirect to Google OAuth
          console.log('🔄 Fallback: Redirecting to /auth/google');
          window.location.href = '/auth/google';
        }
      });
      
      // Add visual feedback for debugging
      loginBtn.addEventListener('mouseenter', () => {
        console.log('🖱️ Mouse entered login button');
      });
      
      loginBtn.addEventListener('mousedown', () => {
        console.log('🖱️ Mouse down on login button');
      });
    } else {
      console.error('❌ Login button not found!');
    }
    
    if (logoutBtn) {
      logoutBtn.addEventListener('click', (e) => {
        console.log('🖱️ Logout button clicked!');
        e.preventDefault();
        
        if (typeof signOut === 'function') {
          signOut();
        } else if (typeof window.signOut === 'function') {
          window.signOut();
        } else {
          console.error('❌ signOut function not found!');
        }
      });
    }



    // Scoring System
    function calculateScore() {
      const grossHourly = parseFloat($("grossHourly").textContent.replace('$', '').replace('/hr', '')) || 0;
      const realHourly = parseFloat($("realHourly").textContent.replace('$', '').replace('/hr', '')) || 0;
      const grossPerMile = parseFloat($("grossPerMile").textContent.replace('$', '').replace('/mi', '')) || 0;
      const netPerMile = parseFloat($("dollarsPerMile").textContent.replace('$', '').replace('/mi', '')) || 0;
      const netProfit = parseFloat($("netProfit").textContent.replace('$', '')) || 0;
      
      let score = 0;
      let maxScore = 100;
      let feedback = [];
      
      // Per-mile rate scoring (40 points)
      if (grossPerMile >= 2.0) {
        score += 40;
        feedback.push("🚀 Excellent per-mile rate!");
      } else if (grossPerMile >= 1.5) {
        score += 30;
        feedback.push("✅ Good per-mile rate");
      } else if (grossPerMile >= 1.0) {
        score += 20;
        feedback.push("⚠️ Acceptable per-mile rate");
      } else {
        score += 0;
        feedback.push("❌ Poor per-mile rate - consider better gigs");
      }
      
      // Real hourly rate scoring (30 points)
      if (realHourly >= 25) {
        score += 30;
        feedback.push("💰 Great hourly earnings!");
      } else if (realHourly >= 20) {
        score += 25;
        feedback.push("💵 Good hourly earnings");
      } else if (realHourly >= 15) {
        score += 20;
        feedback.push("📈 Decent hourly earnings");
      } else if (realHourly >= 10) {
        score += 10;
        feedback.push("📉 Low hourly earnings");
      } else {
        score += 0;
        feedback.push("💸 Very low hourly earnings");
      }
      
      // Net profit scoring (20 points)
      if (netProfit >= 100) {
        score += 20;
        feedback.push("🎯 High profit shift!");
      } else if (netProfit >= 50) {
        score += 15;
        feedback.push("🎯 Good profit shift");
      } else if (netProfit >= 20) {
        score += 10;
        feedback.push("📊 Decent profit");
      } else if (netProfit >= 0) {
        score += 5;
        feedback.push("⚖️ Break-even shift");
      } else {
        score += 0;
        feedback.push("💸 Loss-making shift");
      }
      
      // Efficiency bonus (10 points)
      const efficiency = grossHourly / realHourly;
      if (efficiency <= 1.2) {
        score += 10;
        feedback.push("⚡ Very efficient!");
      } else if (efficiency <= 1.4) {
        score += 7;
        feedback.push("⚡ Efficient operation");
      } else if (efficiency <= 1.6) {
        score += 4;
        feedback.push("📊 Average efficiency");
      } else {
        score += 0;
        feedback.push("📉 High cost ratio");
      }
      
      return {
        score: Math.min(score, maxScore),
        maxScore: maxScore,
        feedback: feedback,
        grade: getGrade(score),
        color: getScoreColor(score)
      };
    }
    
    function getGrade(score) {
      if (score >= 90) return "A+";
      if (score >= 80) return "A";
      if (score >= 70) return "B+";
      if (score >= 60) return "B";
      if (score >= 50) return "C+";
      if (score >= 40) return "C";
      if (score >= 30) return "D";
      return "F";
    }
    
    function getScoreColor(score) {
      if (score >= 80) return "text-green-400";
      if (score >= 60) return "text-yellow-400";
      if (score >= 40) return "text-orange-400";
      return "text-red-400";
    }
    
    // Scorecard Functions
    function createScorecard() {
      // Check if required fields are filled
      const missingFields = requiredFields.filter(field => !$(field).value || $(field).value.trim() === '');
      
      if (missingFields.length > 0) {
        showNotification('Please fill in all required fields to create a scorecard', 'warning');
        return;
      }
      
      // Calculate first to get updated results
      calc();
      
      const scoreData = calculateScore();
      const scorecardHTML = generateScorecardHTML(scoreData);
      
      document.getElementById('scorecardContent').innerHTML = scorecardHTML;
      document.getElementById('scorecardModal').classList.remove('hidden');
    }
    
    function generateScorecardHTML(scoreData) {
      const grossHourly = $("grossHourly").textContent;
      const realHourly = $("realHourly").textContent;
      const netProfit = $("netProfit").textContent;
      const grossPerMile = $("grossPerMile").textContent;
      const netPerMile = $("dollarsPerMile").textContent;
      const hours = $("hours").value;
      const miles = $("miles").value;
      
      return `
        <div class="text-center space-y-6">
          <!-- Header -->
          <div class="space-y-2">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
              🚛 Gig Scorecard
            </h1>
            <p class="text-slate-400">Performance Report</p>
          </div>
          
          <!-- Score Display -->
          <div class="bg-gradient-to-br from-slate-800 to-slate-700 rounded-2xl p-6 border border-slate-600">
            <div class="text-6xl font-bold ${scoreData.color} mb-2">${scoreData.score}</div>
            <div class="text-2xl font-semibold text-slate-300 mb-1">${scoreData.grade}</div>
            <div class="text-slate-400">out of ${scoreData.maxScore}</div>
          </div>
          
          <!-- Key Metrics -->
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-slate-800 rounded-xl p-4 border border-slate-600">
              <div class="text-sm text-slate-400">Real Hourly</div>
              <div class="text-xl font-bold text-blue-400">${realHourly}</div>
            </div>
            <div class="bg-slate-800 rounded-xl p-4 border border-slate-600">
              <div class="text-sm text-slate-400">Net Profit</div>
              <div class="text-xl font-bold text-green-400">${netProfit}</div>
            </div>
            <div class="bg-slate-800 rounded-xl p-4 border border-slate-600">
              <div class="text-sm text-slate-400">Per Mile (Net)</div>
              <div class="text-xl font-bold text-purple-400">${netPerMile}</div>
            </div>
            <div class="bg-slate-800 rounded-xl p-4 border border-slate-600">
              <div class="text-sm text-slate-400">Hours Worked</div>
              <div class="text-xl font-bold text-yellow-400">${hours}h</div>
            </div>
          </div>
          
          <!-- Feedback -->
          <div class="bg-slate-800 rounded-xl p-4 border border-slate-600">
            <h3 class="text-lg font-semibold text-white mb-3">Performance Feedback</h3>
            <div class="space-y-2">
              ${scoreData.feedback.map(feedback => ('<div class="text-slate-300">' + feedback + '</div>')).join('')}
            </div>
          </div>
          
          <!-- Footer -->
          <div class="text-xs text-slate-500">
            Generated by Gig Calculator • Powered by Hey Dispatch • ${new Date().toLocaleDateString()}
          </div>
        </div>
      `;
    }
    
    function closeScorecard() {
      document.getElementById('scorecardModal').classList.add('hidden');
    }
    
    // Generate a beautiful scorecard image
    function generateScorecardImage() {
      const scoreData = calculateScore();
      const grossHourly = parseFloat($("grossHourly").textContent.replace('$', '').replace('/hr', '')) || 0;
      const netHourly = parseFloat($("realHourly").textContent.replace('$', '').replace('/hr', '')) || 0;
      const netProfit = parseFloat($("netProfit").textContent.replace('$', '')) || 0;
      const hours = parseFloat($("hours").value) || 0;
      const miles = parseFloat($("miles").value) || 0;
      
      // Create canvas for the scorecard
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 1200;
      canvas.height = 800;
      
      // Background gradient
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      gradient.addColorStop(0, '#0f172a');
      gradient.addColorStop(0.5, '#1e293b');
      gradient.addColorStop(1, '#0f172a');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Add subtle grid pattern
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
      ctx.lineWidth = 1;
      for (let i = 0; i < canvas.width; i += 40) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, canvas.height);
        ctx.stroke();
      }
      for (let i = 0; i < canvas.height; i += 40) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(canvas.width, i);
        ctx.stroke();
      }
      
      // Header section
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 48px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('GIG PERFORMANCE SCORECARD', canvas.width / 2, 80);
      
      // Subtitle
      ctx.font = '24px Arial';
      ctx.fillStyle = '#94a3b8';
      ctx.fillText('Powered by Hey Dispatch', canvas.width / 2, 120);
      
      // Score circle (larger and more prominent)
      const centerX = canvas.width / 2;
      const centerY = 280;
      const radius = 120;
      
      // Outer glow
      const glowGradient = ctx.createRadialGradient(centerX, centerY, radius - 20, centerX, centerY, radius + 30);
      glowGradient.addColorStop(0, scoreData.score >= 70 ? 'rgba(16, 185, 129, 0.3)' : scoreData.score >= 50 ? 'rgba(245, 158, 11, 0.3)' : 'rgba(239, 68, 68, 0.3)');
      glowGradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
      ctx.fillStyle = glowGradient;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius + 30, 0, 2 * Math.PI);
      ctx.fill();
      
      // Main score circle
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.fillStyle = scoreData.score >= 70 ? '#10b981' : scoreData.score >= 50 ? '#f59e0b' : '#ef4444';
      ctx.fill();
      
      // Inner circle for depth
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius - 20, 0, 2 * Math.PI);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.fill();
      
      // Score text
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 84px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(scoreData.score.toString(), centerX, centerY + 20);
      
      // Grade text
      ctx.font = 'bold 36px Arial';
      ctx.fillText(`Grade: ${scoreData.grade}`, centerX, centerY + 70);
      
      // Stats boxes
      const boxWidth = 280;
      const boxHeight = 120;
      const boxY = 450;
      const spacing = 40;
      const totalWidth = (boxWidth * 3) + (spacing * 2);
      const startX = (canvas.width - totalWidth) / 2;
      
      // Box data
      const boxes = [
        {
          title: 'GROSS HOURLY',
          value: `$${grossHourly.toFixed(2)}/hr`,
          color: '#10b981',
          x: startX
        },
        {
          title: 'NET HOURLY', 
          value: `$${netHourly.toFixed(2)}/hr`,
          color: '#3b82f6',
          x: startX + boxWidth + spacing
        },
        {
          title: 'TOTAL PROFIT',
          value: `$${netProfit.toFixed(2)}`,
          color: '#8b5cf6',
          x: startX + (boxWidth + spacing) * 2
        }
      ];
      
      boxes.forEach(box => {
        // Box background
        ctx.fillStyle = 'rgba(30, 41, 59, 0.8)';
        ctx.fillRect(box.x, boxY, boxWidth, boxHeight);
        
        // Box border
        ctx.strokeStyle = box.color;
        ctx.lineWidth = 3;
        ctx.strokeRect(box.x, boxY, boxWidth, boxHeight);
        
        // Title
        ctx.fillStyle = '#94a3b8';
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(box.title, box.x + boxWidth/2, boxY + 30);
        
        // Value
        ctx.fillStyle = box.color;
        ctx.font = 'bold 32px Arial';
        ctx.fillText(box.value, box.x + boxWidth/2, boxY + 70);
      });
      
      // Bottom stats
      const bottomY = 650;
      ctx.fillStyle = '#e2e8f0';
      ctx.font = '24px Arial';
      ctx.textAlign = 'left';
      
      const leftStats = `${hours.toFixed(1)} Hours Worked • ${miles.toFixed(0)} Miles Driven`;
      const date = new Date().toLocaleDateString();
      
      ctx.fillText(leftStats, 60, bottomY);
      ctx.textAlign = 'right';
      ctx.fillText(date, canvas.width - 60, bottomY);
      
      // Footer
      ctx.fillStyle = '#64748b';
      ctx.font = 'italic 20px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('"Track your hustle, maximize your profit"', canvas.width / 2, 720);
      
      return canvas;
    }
    
    function shareScorecard() {
      try {
        const canvas = generateScorecardImage();
        const scoreData = calculateScore();
        
        // Generate filename with score and date
        const date = new Date().toISOString().split('T')[0];
        const filename = `gig-scorecard-${scoreData.score}-${date}.png`;
        
        // Convert canvas to blob and download
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          showNotification('Scorecard image downloaded! 📸', 'success');
        }, 'image/png');
        
      } catch (error) {
        console.error('Error generating scorecard:', error);
        showNotification('Failed to generate scorecard image', 'error');
      }
    }
    

    
    function copyScorecardImageUrl() {
      try {
        const canvas = generateScorecardImage();
        const scoreData = calculateScore();
        
        // Convert canvas to blob and create object URL
        canvas.toBlob(async (blob) => {
          const imageUrl = URL.createObjectURL(blob);
          
          // Open custom share page in new window/tab
          const shareWindow = window.open('', '_blank');
          const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Share Scorecard Image</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .container { text-align: center; max-width: 600px; width: 100%; }
    .url-container { background: #1e293b; border: 2px solid #334155; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .url-text { font-family: 'Courier New', monospace; font-size: 14px; color: #94a3b8; background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #475569; word-break: break-all; margin-bottom: 15px; user-select: all; }
    .copy-btn { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .copy-btn:hover { background: #2563eb; transform: translateY(-1px); }
    .copy-btn:active { transform: translateY(0); }
    .copy-btn.copied { background: #10b981; }
    .notification { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 500; opacity: 0; transform: translateX(100%); transition: all 0.3s; z-index: 1000; }
    .notification.show { opacity: 1; transform: translateX(0); }
    .image-preview { max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 20px; }
    h1 { color: #f1f5f9; margin-bottom: 20px; font-size: 24px; font-weight: 700; }
    p { color: #94a3b8; margin-bottom: 20px; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📸 Scorecard Image URL</h1>
    <p>Copy this URL to share your scorecard image:</p>
    <img src="REPLACE_IMAGE_URL" alt="Scorecard Preview" class="image-preview">
    <div class="url-container">
      <div class="url-text" id="imageUrl">REPLACE_IMAGE_URL</div>
      <button class="copy-btn" id="copyBtn">📋 Copy URL</button>
    </div>
  </div>
  <div class="notification" id="notification">URL copied to clipboard! ✅</div>
</body>
</html>`;
          
          // Replace placeholders with actual imageUrl
          const finalHtml = htmlContent.replace(/REPLACE_IMAGE_URL/g, imageUrl);
          shareWindow.document.write(finalHtml);

          // Wire up copy interactions in the new window (avoid inline script to prevent closing-tag parse issues)
          const copyBtn = shareWindow.document.getElementById('copyBtn');
          const notificationEl = shareWindow.document.getElementById('notification');
          const urlTextEl = shareWindow.document.getElementById('imageUrl');

          if (copyBtn && urlTextEl) {
            copyBtn.addEventListener('click', async () => {
              try {
                await shareWindow.navigator.clipboard.writeText(imageUrl);
                copyBtn.textContent = '✅ Copied!';
                copyBtn.classList.add('copied');
                if (notificationEl) notificationEl.classList.add('show');
                setTimeout(() => {
                  copyBtn.textContent = '📋 Copy URL';
                  copyBtn.classList.remove('copied');
                  if (notificationEl) notificationEl.classList.remove('show');
                }, 2000);
              } catch (err) {
                // Fallback: select text
                try {
                  const range = shareWindow.document.createRange();
                  range.selectNodeContents(urlTextEl);
                  const selection = shareWindow.getSelection();
                  selection.removeAllRanges();
                  selection.addRange(range);
                  copyBtn.textContent = '📝 Selected - Press Ctrl+C';
                  setTimeout(() => { copyBtn.textContent = '📋 Copy URL'; }, 3000);
                } catch (_) {}
              }
            });

            urlTextEl.addEventListener('click', () => {
              try {
                const range = shareWindow.document.createRange();
                range.selectNodeContents(urlTextEl);
                const selection = shareWindow.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
              } catch (_) {}
            });
          }

          shareWindow.document.close();
          showNotification('Share page opened in new tab! 🚀', 'success');
          
        }, 'image/png');
        
      } catch (error) {
        console.error('Error generating scorecard:', error);
        showNotification('Failed to generate scorecard image', 'error');
      }
    }
    
    function showImageShareModal(blob, shareText) {
      // Create object URL for the image
      const imageUrl = URL.createObjectURL(blob);
      
      // Create sharing modal
      const shareModal = document.createElement('div');
      shareModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
      const modalId = Date.now();
      shareModal.innerHTML = 
        '<div class="bg-slate-800 rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">' +
          '<div class="flex justify-between items-center mb-4">' +
            '<h3 class="text-xl font-bold text-white">Share Your Scorecard</h3>' +
            '<button class="close-btn text-slate-400 hover:text-white text-2xl">' +
              '<i class="fas fa-times"></i>' +
            '</button>' +
          '</div>' +
          
          '<!-- Preview Image -->' +
          '<div class="mb-4 text-center">' +
            '<img class="scorecard-preview max-w-full h-auto rounded-lg border border-slate-600" style="max-height: 300px;" alt="Scorecard">' +
          '</div>' +
          
          '<!-- Share Instructions -->' +
          '<div class="space-y-4">' +
            '<div class="bg-slate-700 rounded-lg p-4">' +
              '<h4 class="font-semibold text-white mb-2">📱 On Mobile:</h4>' +
              '<p class="text-slate-300 text-sm">Long press the image above, then select "Save to Photos" or "Share Image"</p>' +
            '</div>' +
            
            '<div class="bg-slate-700 rounded-lg p-4">' +
              '<h4 class="font-semibold text-white mb-2">💻 On Desktop:</h4>' +
              '<p class="text-slate-300 text-sm">Right-click the image above and select "Save image as..." or "Copy image"</p>' +
            '</div>' +
            
            '<div class="bg-indigo-700 rounded-lg p-4">' +
              '<h4 class="font-semibold text-white mb-2">📝 Share Text:</h4>' +
              '<p class="text-indigo-200 text-sm bg-indigo-800 p-2 rounded border select-all" id="shareText-' + modalId + '"></p>' +
              '<button id="copyTextBtn-' + modalId + '" class="mt-2 px-3 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-sm text-white">' +
                'Copy Text' +
              '</button>' +
            '</div>' +
          '</div>' +
          
          '<button class="close-btn w-full mt-4 px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white transition-all">' +
            'Close' +
          '</button>' +
        '</div>';
        
      // Set image and text after creating the modal
      const previewImg = shareModal.querySelector('.scorecard-preview');
      const shareTextEl = shareModal.querySelector('#shareText-' + modalId);
      previewImg.src = imageUrl;
      shareTextEl.textContent = shareText;
      
      // Add close button handlers
      const closeButtons = shareModal.querySelectorAll('.close-btn');
      closeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          shareModal.remove();
          URL.revokeObjectURL(imageUrl);
        });
      });
      
      document.body.appendChild(shareModal);
      
      // Add copy text functionality
      const copyTextBtn = shareModal.querySelector('[id^="copyTextBtn-"]');
      if (copyTextBtn) {
        copyTextBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(shareText);
            showNotification('Share text copied to clipboard! 📋', 'success');
            copyTextBtn.textContent = 'Copied!';
            setTimeout(() => {
              copyTextBtn.textContent = 'Copy Text';
            }, 2000);
          } catch (err) {
            console.error('Failed to copy text:', err);
            
            // Fallback: Select the text
            const textElement = shareModal.querySelector('.select-all');
            if (textElement) {
              const range = document.createRange();
              range.selectNodeContents(textElement);
              const selection = window.getSelection();
              selection.removeAllRanges();
              selection.addRange(range);
              showNotification('Text selected - press Ctrl+C to copy', 'info');
            } else {
              showNotification('Failed to copy text', 'error');
            }
          }
        });
      }
      
      // Clean up on click outside
      shareModal.addEventListener('click', (e) => {
        if (e.target === shareModal) {
          shareModal.remove();
          URL.revokeObjectURL(imageUrl);
        }
      });
    }

    // Save current calculation to database
    async function saveCurrentCalculation() {
      try {
        // Check authentication first
        const authResponse = await fetch('/api/auth/status');
        const authData = await authResponse.json();
        
        if (!authData.authenticated) {
          showNotification('Please sign in to save calculations', 'error');
          return;
        }

        // Get input values
        const v = read();
        
        // Get calculated values from UI
        const grossHourly = parseFloat($("grossHourly").textContent.replace('$', '').replace('/hr', '')) || 0;
        const netHourly = parseFloat($("realHourly").textContent.replace('$', '').replace('/hr', '')) || 0;
        const fuelCost = parseFloat($("fuelCost").textContent.replace('$', '')) || 0;
        const vehicleCost = parseFloat($("vehicleCost").textContent.replace('$', '')) || 0;
        const estTax = parseFloat($("estTax").textContent.replace('$', '')) || 0;
        const grossPerMile = parseFloat($("grossPerMile").textContent.replace('$', '').replace('/mi', '')) || 0;
        const netPerMile = parseFloat($("dollarsPerMile").textContent.replace('$', '').replace('/mi', '')) || 0;
        const grossPerMileAll = parseFloat($("activeGrossDpm").textContent.replace('$', '').replace('/mi', '')) || 0;
        const netPerMileAll = parseFloat($("activeDpm").textContent.replace('$', '').replace('/mi', '')) || 0;
        const scoreData = calculateScore();

        // Prepare calculation data for database
        const calculationData = {
          // Input data
          miles_driven: parseFloat(v.miles) || 0,
          trip_miles: parseFloat(v.onTripMiles) || 0,
          time_hours: parseFloat(v.hours) || 0,
          total_earnings: (parseFloat(v.gross) || 0) + (parseFloat(v.tips) || 0),
          gas_price: parseFloat(v.gas) || 0,
          mpg: parseFloat(v.mpg) || 0,
          wear_tear_rate: parseFloat(v.wear) || 0.67,
          tax_rate: parseFloat(v.tax) || 0,
          
          // Calculated results
          gross_hourly: grossHourly,
          net_hourly: netHourly,
          fuel_cost: fuelCost,
          wear_tear_cost: vehicleCost,
          estimated_tax: estTax,
          gross_per_mile: grossPerMile,
          net_per_mile: netPerMile,
          gross_per_mile_all: grossPerMileAll,
          net_per_mile_all: netPerMileAll,
          
          // Scorecard data
          score: scoreData.score || 0,
          score_grade: scoreData.grade || 'F',
          
          // Metadata
          notes: '' // Could add a notes field to UI later
        };

        console.log('💾 Saving calculation to database:', calculationData);

        // Save to database via API
        const response = await fetch('/api/calculations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(calculationData)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('✅ Calculation saved successfully:', result.calculation.id);
          showNotification('Calculation saved to your account!', 'success');
          
          // Refresh the saved calculations display
          setTimeout(() => {
            loadSavedCalculations();
          }, 500);
        } else {
          const error = await response.json();
          console.error('❌ Failed to save calculation:', error);
          showNotification('Failed to save calculation: ' + (error.error || 'Unknown error'), 'error');
        }

      } catch (error) {
        console.error('❌ Error saving calculation:', error);
        showNotification('Error saving calculation. Please try again.', 'error');
      }
    }

    // Number validation function
    function validateNumber(input, min = 0, max = null) {
      let value = input.value;
      
      // Remove any non-numeric characters except decimal point
      value = value.replace(/[^0-9.]/g, '');
      
      // Ensure only one decimal point
      const parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      
      // Convert to number and validate
      let numValue = parseFloat(value);
      if (isNaN(numValue)) {
        numValue = 0;
      }
      
      // Apply min/max constraints
      if (numValue < min) numValue = min;
      if (max !== null && numValue > max) numValue = max;
      
      // Update input value
      input.value = numValue;
      
      // Trigger calculation
      calc();
    }

    // Decimal validation function (more flexible for currency inputs)
    function validateDecimal(input, min = 0, max = null) {
      const cursorPosition = input.selectionStart;
      let value = input.value;
      let originalLength = value.length;
      
      // Remove any non-numeric characters except decimal point
      value = value.replace(/[^0-9.]/g, '');
      
      // Ensure only one decimal point
      const parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      
      // Limit decimal places to 2 for currency
      if (parts.length === 2 && parts[1].length > 2) {
        value = parts[0] + '.' + parts[1].substring(0, 2);
      }
      
      // Only update if value actually changed
      if (input.value !== value) {
        input.value = value;
        
        // Restore cursor position
        const lengthDifference = originalLength - value.length;
        const newCursorPosition = Math.max(0, cursorPosition - lengthDifference);
        input.setSelectionRange(newCursorPosition, newCursorPosition);
      }
      
      // Only validate constraints if we have a complete number
      if (value !== '' && value !== '.') {
        let numValue = parseFloat(value);
        if (!isNaN(numValue)) {
          // Apply min/max constraints
          if (numValue < min) {
            input.value = min.toString();
          }
          if (max !== null && numValue > max) {
            input.value = max.toString();
          }
        }
      }
      
      // Trigger calculation
      calc();
    }

    // Format currency to always show 2 decimal places
    function formatCurrency(amount) {
      if (isNaN(amount) || amount === null || amount === undefined) {
        return '$0.00';
      }
      return '$' + parseFloat(amount).toFixed(2);
    }

    // Format percentage to always show 1 decimal place
    function formatPercentage(amount) {
      if (isNaN(amount) || amount === null || amount === undefined) {
        return '0.0%';
      }
      return parseFloat(amount).toFixed(1) + '%';
    }

    // Saved Calculations Display
    let allCalculations = [];
    let currentPage = 1;
    let calculationsPerPage = 5;
    let showAllMode = false;

    async function loadSavedCalculations() {
      const calculationsLoading = document.getElementById('calculationsLoading');
      const noCalculations = document.getElementById('noCalculations');
      const calculationsList = document.getElementById('calculationsList');
      const calculationCount = document.getElementById('calculationCount');
      
      // Show loading
      calculationsLoading.classList.remove('hidden');
      noCalculations.classList.add('hidden');
      calculationsList.classList.add('hidden');
      document.getElementById('paginationControls').classList.add('hidden');
      calculationCount.classList.add('hidden');
      
      try {
        let calculations = [];
        
        console.log('🔍 Loading calculations from database...');
        
        // Check if user is authenticated first
        const authResponse = await fetch('/api/auth/status');
        const authData = await authResponse.json();
        
        console.log('🔐 Auth status:', authData);
        
        if (authData.authenticated) {
          console.log('📡 Fetching from database for user:', authData.user.email);
          
          // Fetch from database API
          const response = await fetch('/api/calculations?limit=50');
          console.log('📡 API response status:', response.status);
          
          if (response.ok) {
            const data = await response.json();
            calculations = data.calculations || [];
            console.log('📊 Database calculations received:', calculations.length);
            console.log('📊 Sample calculation:', calculations[0]);
          } else {
            const errorText = await response.text();
            console.error('❌ Failed to fetch calculations from database:', response.status, errorText);
          }
        } else {
          console.log('❌ User not authenticated, cannot load calculations');
        }
        
        // Store all calculations globally (database returns newest first)
        allCalculations = calculations;
        currentPage = 1;
        
        // Hide loading
        calculationsLoading.classList.add('hidden');
        
        if (calculations.length === 0) {
          noCalculations.classList.remove('hidden');
          calculationCount.classList.add('hidden');
          document.getElementById('toggleViewMode').classList.add('hidden');
          document.getElementById('quickStats').classList.add('hidden');
          document.getElementById('performanceInsights').classList.add('hidden');
          document.getElementById('totalSavedCount').textContent = '0';
        } else {
          // Update count badges
          calculationCount.textContent = calculations.length;
          calculationCount.classList.remove('hidden');
          document.getElementById('totalSavedCount').textContent = calculations.length;
          
          // Show toggle button if more than 5 calculations
          const toggleBtn = document.getElementById('toggleViewMode');
          if (calculations.length > calculationsPerPage) {
            toggleBtn.classList.remove('hidden');
          } else {
            toggleBtn.classList.add('hidden');
          }
          
          // Calculate and display quick stats
          updateQuickStats(calculations);
          
          displayCalculationsPage();
          calculationsList.classList.remove('hidden');
          document.getElementById('quickStats').classList.remove('hidden');
          document.getElementById('performanceInsights').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading calculations:', error);
        calculationsLoading.classList.add('hidden');
        noCalculations.classList.remove('hidden');
      }
    }

    function displayCalculationsPage() {
      const calculationsList = document.getElementById('calculationsList');
      const paginationControls = document.getElementById('paginationControls');
      const toggleBtn = document.getElementById('toggleViewMode');
      
      calculationsList.innerHTML = '';
      
      let calculationsToShow = [];
      let startIndex, endIndex;
      
      if (showAllMode) {
        calculationsToShow = allCalculations;
        startIndex = 0;
        endIndex = allCalculations.length;
        paginationControls.classList.add('hidden');
        toggleBtn.innerHTML = '<i class="fas fa-th-list mr-1"></i>Show Less';
      } else {
        const totalPages = Math.ceil(allCalculations.length / calculationsPerPage);
        startIndex = (currentPage - 1) * calculationsPerPage;
        endIndex = Math.min(startIndex + calculationsPerPage, allCalculations.length);
        calculationsToShow = allCalculations.slice(startIndex, endIndex);
        
        if (allCalculations.length > calculationsPerPage) {
          paginationControls.classList.remove('hidden');
          updatePaginationControls(totalPages);
        }
        toggleBtn.innerHTML = '<i class="fas fa-list mr-1"></i>Show All';
      }
      
      calculationsToShow.forEach((calc, index) => {
        const calcElement = document.createElement('div');
        calcElement.className = 'bg-slate-700/40 rounded-xl p-6 border border-slate-600/30 hover:bg-slate-700/60 transition-all shadow-lg hover:shadow-xl';
        
        const date = calc.created_at ? new Date(calc.created_at).toLocaleDateString() : 'Recent';
        const time = calc.created_at ? new Date(calc.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        const grossHourly = parseFloat(calc.gross_hourly) || 0;
        const netHourly = parseFloat(calc.net_hourly) || 0;
        const score = parseInt(calc.score) || 0;
        const totalEarnings = parseFloat(calc.total_earnings) || 0;
        const hours = parseFloat(calc.time_hours) || 0;
        const miles = parseFloat(calc.miles_driven) || 0;
        
        // Calculate actual index in full array
        const actualIndex = showAllMode ? index : startIndex + index;
        
        calcElement.innerHTML = `
          <div class="flex flex-col sm:flex-row justify-between items-start space-y-4 sm:space-y-0">
            <div class="flex items-start space-x-4 flex-1">
              <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg">
                #${actualIndex + 1}
              </div>
              <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                  <div class="text-slate-200 font-semibold text-lg">${date}</div>
                  ${time ? `<div class="text-slate-400 text-sm">${time}</div>` : ''}
                </div>
                
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 text-sm">
                  <div>
                    <div class="text-slate-400">Total Earnings</div>
                    <div class="text-green-400 font-semibold">$${totalEarnings.toFixed(2)}</div>
                  </div>
                  <div>
                    <div class="text-slate-400">Hours</div>
                    <div class="text-blue-400 font-semibold">${hours.toFixed(1)}h</div>
                  </div>
                  <div>
                    <div class="text-slate-400">Miles</div>
                    <div class="text-purple-400 font-semibold">${miles.toFixed(0)}</div>
                  </div>
                  <div>
                    <div class="text-slate-400">Net Rate</div>
                    <div class="text-cyan-400 font-semibold">$${netHourly.toFixed(2)}/hr</div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="flex items-center space-x-4">
              <div class="text-center">
                <div class="text-2xl font-bold ${score >= 70 ? 'text-green-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400'} mb-1">
                  ${score}
                </div>
                <div class="text-xs text-slate-400 uppercase tracking-wider">Score</div>
              </div>
              
              <div>
                <button class="delete-btn px-4 py-2 bg-red-600/80 hover:bg-red-600 rounded-lg text-sm font-medium text-white transition-all">
                  <i class="fas fa-trash mr-1"></i>Delete
                </button>
              </div>
            </div>
          </div>
        `;
        
        calculationsList.appendChild(calcElement);

        // Wire delete button without inline JS to avoid template literal parsing issues
        const deleteBtn = calcElement.querySelector('.delete-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deleteCalculation(actualIndex));
        }
      });
      
      // Store calculations for loading
      window.savedCalculationsData = allCalculations;
    }

    function updatePaginationControls(totalPages) {
      const showingRange = document.getElementById('showingRange');
      const totalCalculations = document.getElementById('totalCalculations');
      const pageInfo = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      
      const startIndex = (currentPage - 1) * calculationsPerPage + 1;
      const endIndex = Math.min(currentPage * calculationsPerPage, allCalculations.length);
      
      showingRange.textContent = `${startIndex}-${endIndex}`;
      totalCalculations.textContent = allCalculations.length;
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
    }

    function changePage(direction) {
      const totalPages = Math.ceil(allCalculations.length / calculationsPerPage);
      
      if (direction === 'prev' && currentPage > 1) {
        currentPage--;
      } else if (direction === 'next' && currentPage < totalPages) {
        currentPage++;
      }
      
      displayCalculationsPage();
    }

    function toggleViewMode() {
      showAllMode = !showAllMode;
      currentPage = 1; // Reset to first page when switching modes
      displayCalculationsPage();
    }

    // Calculate and update quick stats
    function updateQuickStats(calculations) {
      if (calculations.length === 0) return;
      
      const avgScore = calculations.reduce((sum, calc) => sum + (parseFloat(calc.score) || 0), 0) / calculations.length;
      const bestHourly = Math.max(...calculations.map(calc => parseFloat(calc.gross_hourly) || 0));
      const totalHours = calculations.reduce((sum, calc) => sum + (parseFloat(calc.time_hours) || 0), 0);
      const totalEarnings = calculations.reduce((sum, calc) => sum + (parseFloat(calc.total_earnings) || 0), 0);
      
      document.getElementById('avgScore').textContent = Math.round(avgScore);
      document.getElementById('bestHourly').textContent = `$${bestHourly.toFixed(2)}`;
      document.getElementById('totalHours').textContent = totalHours.toFixed(1);
      document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
      
      // Update performance insights
      updatePerformanceInsights(calculations);
    }

    // Update performance insights
    function updatePerformanceInsights(calculations) {
      // Top performing calculations
      const topCalcs = [...calculations]
        .sort((a, b) => (parseFloat(b.score) || 0) - (parseFloat(a.score) || 0))
        .slice(0, 3);
      
      const topCalculationsEl = document.getElementById('topCalculations');
      topCalculationsEl.innerHTML = topCalcs.map((calc, index) => {
        const date = calc.created_at ? new Date(calc.created_at).toLocaleDateString() : 'Recent';
        const score = parseInt(calc.score) || 0;
        const grossHourly = parseFloat(calc.gross_hourly) || 0;
        
        return `
          <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 bg-yellow-${index === 0 ? '500' : index === 1 ? '600' : '700'} rounded-full flex items-center justify-center text-white font-bold text-sm">
                ${index + 1}
              </div>
              <div>
                <div class="text-slate-200 font-medium">${date}</div>
                <div class="text-xs text-slate-400">$${grossHourly.toFixed(2)}/hr</div>
              </div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold ${score >= 70 ? 'text-green-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400'}">
                ${score}
              </div>
              <div class="text-xs text-slate-400">Score</div>
            </div>
          </div>
        `;
      }).join('');
      
      // Recent activity
      const recentCalcs = calculations.slice(0, 5);
      const recentActivityEl = document.getElementById('recentActivity');
      recentActivityEl.innerHTML = recentCalcs.map(calc => {
        const date = calc.created_at ? new Date(calc.created_at).toLocaleDateString() : 'Recent';
        const score = parseInt(calc.score) || 0;
        const netHourly = parseFloat(calc.net_hourly) || 0;
        
        return `
          <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
            <div>
              <div class="text-slate-200 font-medium">${date}</div>
              <div class="text-xs text-slate-400">Net: $${netHourly.toFixed(2)}/hr</div>
            </div>
            <div class="text-lg font-bold ${score >= 70 ? 'text-green-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400'}">
              ${score}
            </div>
          </div>
        `;
      }).join('');
    }

    // Sort calculations
    function sortCalculations() {
      const sortBy = document.getElementById('sortCalculations').value;
      
      switch (sortBy) {
        case 'newest':
          allCalculations.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          break;
        case 'oldest':
          allCalculations.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
          break;
        case 'highest_score':
          allCalculations.sort((a, b) => (parseFloat(b.score) || 0) - (parseFloat(a.score) || 0));
          break;
        case 'lowest_score':
          allCalculations.sort((a, b) => (parseFloat(a.score) || 0) - (parseFloat(b.score) || 0));
          break;
        case 'highest_earnings':
          allCalculations.sort((a, b) => (parseFloat(b.gross_hourly) || 0) - (parseFloat(a.gross_hourly) || 0));
          break;
      }
      
      currentPage = 1;
      displayCalculationsPage();
      updateQuickStats(allCalculations);
    }

    // Export calculations as CSV
    function exportCalculations() {
      if (allCalculations.length === 0) {
        showNotification('No calculations to export', 'error');
        return;
      }
      
      // Prepare CSV data
      const headers = [
        'Date', 'Hours', 'Miles', 'Total Earnings', 'Gross Hourly', 'Net Hourly',
        'Fuel Cost', 'Wear Tear Cost', 'Tax', 'Score', 'Grade'
      ];
      
      const csvData = allCalculations.map(calc => [
        calc.created_at ? new Date(calc.created_at).toLocaleDateString() : '',
        calc.time_hours || 0,
        calc.miles_driven || 0,
        calc.total_earnings || 0,
        calc.gross_hourly || 0,
        calc.net_hourly || 0,
        calc.fuel_cost || 0,
        calc.wear_tear_cost || 0,
        calc.estimated_tax || 0,
        calc.score || 0,
        calc.score_grade || ''
      ]);
      
      // Create CSV content
      const csvContent = [
        headers.join(','),
        ...csvData.map(row => row.join(','))
      ].join('\n');
      
      // Download file
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gig-calculations-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      showNotification('Calculations exported successfully!', 'success');
    }

    // Delete calculation
    async function deleteCalculation(index) {
      const calculations = window.savedCalculationsData;
      if (!calculations || !calculations[index]) return;
      
      const calc = calculations[index];
      
      if (!confirm('Are you sure you want to delete this calculation? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/calculations/${calc.id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (response.ok) {
          showNotification('Calculation deleted successfully!', 'success');
          // Refresh the display
          setTimeout(() => {
            loadSavedCalculations();
          }, 500);
        } else {
          const error = await response.json();
          showNotification('Failed to delete calculation: ' + (error.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Error deleting calculation:', error);
        showNotification('Error deleting calculation. Please try again.', 'error');
      }
    }

    // Auth functions will be loaded from auth.js
    console.log('🔧 Auth functions loading from external script');

    // Initialize
    load();
    checkAuthStatus();
    
    // Set up event listeners and load calculations
    setTimeout(() => {
      const refreshBtn = document.getElementById('refreshCalculations');
      const toggleBtn = document.getElementById('toggleViewMode');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      const manualLoadBtn = document.getElementById('manualLoad');
      const testAdminBtn = document.getElementById('testAdminView');
      const sortSelect = document.getElementById('sortCalculations');
      const exportBtn = document.getElementById('exportCalculations');
      
      if (refreshBtn) {
        refreshBtn.addEventListener('click', loadSavedCalculations);
      }
      
      if (manualLoadBtn) {
        manualLoadBtn.addEventListener('click', loadSavedCalculations);
      }
      
      if (testAdminBtn) {
        testAdminBtn.addEventListener('click', () => {
          window.open('/api/admin/users', '_blank');
        });
      }
      
      if (sortSelect) {
        sortSelect.addEventListener('change', sortCalculations);
      }
      
      if (exportBtn) {
        exportBtn.addEventListener('click', exportCalculations);
      }
      
      if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleViewMode);
      }
      
      if (prevBtn) {
        prevBtn.addEventListener('click', () => changePage('prev'));
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', () => changePage('next'));
      }
      
      // Load calculations after page is ready and auth is checked
      setTimeout(() => {
        loadSavedCalculations();
      }, 2000); // Give more time for auth to be established
    }, 1000);
  </script>
</body>
</html>


